# quark_deleter
夸克网盘空间不足自动清理删除文件脚本

好的，为你编写一份详细的使用说明文档，以便你开源此项目。

---

# 夸克网盘自动清理脚本 (Quark Drive Auto Cleaner)

## 简介

本项目是一个Python脚本，旨在帮助用户自动清理其夸克网盘指定文件夹内的过期内容（包括文件和文件夹）。脚本会定期轮询指定文件夹，并删除其中在用户网盘中保存时间超过设定阈值（默认为1小时）的所有条目，以释放网盘空间。

主要功能：
*   **定期轮询**：默认每5分钟检查一次。
*   **过期删除**：默认删除保存超过1小时的条目。
*   **统一处理**：无论是文件还是文件夹，只要符合过期条件，都会被加入删除队列。
*   **基于Cookie认证**：通过用户提供的夸克网盘Cookie进行操作。
*   **日志记录**：记录详细的操作过程和潜在错误，方便追踪和调试。

**警告：**
*   **此脚本会真实删除你的网盘文件和文件夹！请务必小心使用，并在测试阶段使用不重要的文件夹和文件。**
*   **夸克网盘的API可能会发生变化，导致此脚本失效。作者不保证脚本的长期有效性。**
*   **Cookie是敏感信息，请妥善保管，不要泄露给他人。**

## 环境要求

*   Python 3.7 或更高版本
*   `requests` 库

## 安装

1.  **下载脚本：**
    从本项目GitHub仓库下载 `quark_deleter_unified.py` (或你最终命名的脚本文件) 到你的服务器或本地机器。

2.  **安装依赖库：**
    打开终端或命令提示符，执行以下命令安装 `requests` 库：
    ```bash
    pip install requests
    ```
    如果你使用的是虚拟环境，请先激活虚拟环境再执行此命令。

## 配置

打开脚本文件 (例如 `quark_deleter_unified.py`)，你需要修改以下配置项：

```python
# --- 1. 配置区域 ---
# !!! 请务必修改以下配置项 !!!
COOKIE = "请在这里粘贴你的夸克网盘COOKIE字符串"
TARGET_FOLDER_ID = "请在这里粘贴你要操作的夸克网盘文件夹ID"
# !!! 以上配置项务必修改 !!!

DELETE_OLDER_THAN_SECONDS = 1 * 60 * 60  # 1小时 (单位：秒)
POLL_INTERVAL_SECONDS = 5 * 60  # 5分钟轮询一次 (单位：秒)

# --- 日志配置 ---
LOG_LEVEL = logging.DEBUG # 日志级别，可选: DEBUG, INFO, WARNING, ERROR
# LOG_FILE_PATH = "quark_deleter.log" # 如果需要输出到文件，取消此行注释并设置路径
# ... (日志配置的其他部分) ...
```

**详细配置说明：**

*   **`COOKIE`**:
    *   **必需。** 你的夸克网盘的完整Cookie字符串。
    *   **获取方法：**
        1.  使用浏览器（推荐Chrome或Edge）登录夸克网盘网页版 (`https://pan.quark.cn/`)。
        2.  按 `F12` 打开开发者工具，切换到 "Network" (网络) 标签。
        3.  在网盘页面进行一些操作，例如刷新页面、打开一个文件夹、或尝试（但不必完成）删除一个文件。目的是触发API请求。
        4.  在网络请求列表中，找到一个发往 `drive-pc.quark.cn` 或 `pan.quark.cn` 的API请求（例如名称中包含 `list`, `sort`, `file/op`, `file/delete` 等的请求，而不是图片、JS或CSS文件）。
        5.  点击该请求，在右侧面板的 "Headers" (标头) 标签下，找到 "Request Headers" (请求标头) 部分。
        6.  复制 `Cookie:` 字段后面跟着的**全部内容**。这是一个很长的字符串，包含了多个键值对，用分号 `;` 分隔。请确保完整复制。
        7.  将复制的完整Cookie字符串粘贴到脚本中 `COOKIE = "..."` 的引号内。

*   **`TARGET_FOLDER_ID`**:
    *   **必需。** 你希望脚本监控和清理的夸克网盘文件夹的ID。
    *   **获取方法：**
        1.  在夸克网盘网页版中，进入你想要操作的目标文件夹。
        2.  观察浏览器地址栏的URL。它通常会是类似 `https://pan.quark.cn/drive?fid=xxxxxxxxxxxxxxxxxxxx` 的形式。
        3.  `fid=` 后面的那串字符（例如 `ae4e38ff3c6d4ac989a981013d61a2ea`）就是该文件夹的ID。
        4.  将这个ID粘贴到脚本中 `TARGET_FOLDER_ID = "..."` 的引号内。
    *   **重要提示：强烈建议首次配置时，使用一个新建的、里面只放有少量可删除测试文件/文件夹的文件夹ID，以验证脚本行为是否符合预期，避免误删重要数据。**

*   **`DELETE_OLDER_THAN_SECONDS`**:
    *   可选，默认为 `3600` (即1小时)。
    *   定义了条目（文件或文件夹）在网盘中保存多久后被视为过期并可以删除。单位是秒。
    *   例如，如果你想删除保存超过24小时的内容，可以设置为 `24 * 60 * 60`。

*   **`POLL_INTERVAL_SECONDS`**:
    *   可选，默认为 `300` (即5分钟)。
    *   脚本每隔多少秒进行一次检查和清理操作。单位是秒。

*   **`LOG_LEVEL`**:
    *   可选，默认为 `logging.DEBUG`。
    *   控制日志输出的详细程度。
        *   `logging.DEBUG`: 输出最详细的日志，包括每个条目的时间判断详情，适合调试。
        *   `logging.INFO`: 输出主要操作信息，如开始检查、发现待删除条目、删除成功/失败等。
        *   `logging.WARNING`: 只输出警告信息。
        *   `logging.ERROR`: 只输出错误信息。
    *   对于日常运行，建议设置为 `logging.INFO`。

*   **`LOG_FILE_PATH`**:
    *   可选，默认为注释状态（不输出到文件，只输出到控制台）。
    *   如果想将日志同时输出到文件，请取消 `LOG_FILE_PATH = "quark_deleter.log"` 这一行的注释 (`#`)，并可以修改引号内的文件路径和名称。脚本会自动创建日志文件。

## 使用方法

1.  **配置脚本：** 按照上一节“配置”中的说明，修改脚本文件中的 `COOKIE` 和 `TARGET_FOLDER_ID`，以及其他可选配置。

2.  **运行脚本：**
    *   **本地直接运行 (用于测试或短期运行)：**
        在终端中，导航到脚本所在的目录，然后执行：
        ```bash
        python quark_deleter_unified.py
        ```
        (如果你的python3命令是 `python3`，则使用 `python3 quark_deleter_unified.py`)
        脚本会开始运行，并在控制台输出日志。你可以按 `Ctrl+C` 来停止脚本。

    *   **服务器后台运行 (推荐用于长期运行，例如使用宝塔面板)：**

        **使用宝塔面板Python项目管理器：**
        1.  将配置好的脚本文件上传到你的服务器，例如路径 `/www/wwwroot/my_quark_cleaner/quark_deleter_unified.py`。
        2.  登录宝塔面板，进入 "网站" -> "Python项目"。
        3.  点击 "添加Python项目"。
        4.  **项目名称：** 自定义，例如 `QuarkCleaner`。
        5.  **项目路径：** 选择你上传脚本的目录，例如 `/www/wwwroot/my_quark_cleaner`。
        6.  **Python版本：** 选择一个与脚本兼容的Python版本（例如 Python 3.7+）。
        7.  **启动方式：** 选择 **“命令行启动”**。
        8.  **启动命令：** 填写 `python3 quark_deleter_unified.py` (如果你的Python解释器是 `python3`) 或 `python quark_deleter_unified.py`。确保这里的脚本文件名与你上传的一致。
        9.  **端口：** 此脚本不监听网络端口，如果宝塔强制要求填写，可以填一个不常用的高位端口（如 `8088`），但脚本本身不会使用它。
        10. **运行用户：** 通常是 `www`。
        11. **开机自启动：** 建议勾选。
        12. 点击 "提交"。
        13. 项目创建后，进入该项目的管理界面：
            *   **模块管理/Pip：** 如果 `requests` 库没有自动安装（或者你没有在系统全局安装），在这里手动添加并安装 `requests` 模块。
            *   **日志查看：** 定期查看项目日志，确认脚本是否正常启动、按预期轮询、以及是否有报错信息（如Cookie失效、API错误等）。

        **使用 `supervisor` 或 `systemd` (更专业的后台管理方式，非宝塔用户可选)：**
        如果你不使用宝塔面板，可以使用 `supervisor` 或 `systemd` 等进程管理工具来确保脚本在后台稳定运行并在意外退出时自动重启。具体配置方法请参考相应工具的文档。

## 注意事项

*   **Cookie 有效期：** 夸克网盘的 Cookie 会定期失效。当 Cookie 失效后，脚本将无法正常工作，通常会在日志中报告认证失败相关的错误。你需要定期手动获取新的 Cookie 并更新到脚本的 `COOKIE` 配置中。此脚本不包含自动刷新 Cookie 的功能。
*   **API 稳定性：** 脚本依赖的夸克网盘API是非官方公开的，可能会随时发生变化，导致脚本无法正常工作。如果遇到API相关的错误，可能需要更新脚本以适应新的API。
*   **删除风险：**
    *   **再次强调，此脚本会真实删除数据。** 请务必在测试阶段小心谨慎，使用专门的测试文件夹。
    *   确认 `TARGET_FOLDER_ID` 配置正确，避免指向错误的文件夹。
    *   在熟悉脚本行为之前，可以将 `DELETE_OLDER_THAN_SECONDS` 设置为一个非常大的值（例如几天或几周），然后通过 `DEBUG` 日志观察哪些文件会被识别为待删除，但脚本实际不会执行删除。确认无误后再调小此值。
*   **网络问题：** 如果服务器网络不稳定或无法访问夸克网盘的API服务器，脚本也无法正常工作。
*   **日志监控：** 强烈建议定期查看脚本的运行日志（无论是控制台输出还是日志文件），以便及时发现并处理问题。

## 故障排查

*   **"无法从Cookie中提取stoken" 或 "Cookie可能已失效"：**
    *   最常见的原因是 `COOKIE` 配置不正确或已过期。请按照“配置”部分的说明重新获取完整的Cookie。
    *   确保复制的是包含所有键值对的完整字符串。
*   **HTTP 401/403 错误：** 通常表示认证失败，Cookie无效或权限不足。
*   **HTTP 404 错误 (针对列文件/文件夹API)：**
    *   `TARGET_FOLDER_ID` 可能不正确或该文件夹不存在于此Cookie对应的账户下。
    *   Cookie权限问题也可能间接导致。
    *   极少数情况下，API端点可能已变更。
*   **未按预期删除文件/文件夹：**
    *   检查 `DELETE_OLDER_THAN_SECONDS` 设置是否正确。
    *   将日志级别设为 `logging.DEBUG`，查看详细的条目信息和时间判断逻辑。确认脚本选择的时间戳字段是否代表“转存到你网盘的时间”，以及时间戳单位（秒/毫秒）是否处理正确。
    *   确认文件/文件夹的识别逻辑（基于 `dir`, `file`, `obj_type` 字段）是否覆盖了所有情况。
*   **脚本无法启动或宝塔项目报错：**
    *   确保Python环境和 `requests` 库已正确安装。
    *   在宝塔面板中，检查Python项目管理器的启动命令是否正确（应为 `python3 your_script_name.py` 或 `python your_script_name.py`）。
    *   检查宝塔项目日志获取更详细的错误信息。

## 贡献

欢迎提交 Pull Requests 或 Issues 来改进此项目。

## 免责声明

本项目按 "原样" 提供，不作任何明示或暗示的保证。对于使用此脚本可能造成的任何数据丢失或损坏，作者不承担任何责任。用户需自行承担使用风险。

